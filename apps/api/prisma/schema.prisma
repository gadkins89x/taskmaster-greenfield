generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// TENANT & AUTHENTICATION
// =============================================================================

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  slug      String   @unique
  settings  Json?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users                User[]
  roles                Role[]
  locations            Location[]
  assets               Asset[]
  workOrders           WorkOrder[]
  maintenanceSchedules MaintenanceSchedule[]
  inventoryItems       InventoryItem[]
  auditLogs            AuditLog[]

  @@map("tenants")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  email        String
  passwordHash String    @map("password_hash")
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  phone        String?
  avatarUrl    String?   @map("avatar_url")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  tenant                   Tenant                   @relation(fields: [tenantId], references: [id])
  userRoles                UserRole[]
  refreshTokens            RefreshToken[]
  createdWorkOrders        WorkOrder[]              @relation("CreatedBy")
  assignedWorkOrders       WorkOrder[]              @relation("AssignedTo")
  completedSteps           WorkOrderStep[]          @relation("CompletedBy")
  comments                 WorkOrderComment[]
  signatures               WorkOrderSignature[]
  uploadedPhotos           WorkOrderPhoto[]         @relation("PhotoUploadedBy")
  laborEntries             WorkOrderLabor[]         @relation("LaborUser")
  partsAdded               WorkOrderPart[]          @relation("PartAddedBy")
  auditLogs                AuditLog[]
  notifications            Notification[]
  notificationPreferences  NotificationPreference[]
  inventoryTransactions    InventoryTransaction[]
  assignedSchedules        MaintenanceSchedule[]    @relation("ScheduleAssignedTo")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id          String @id @default(uuid()) @db.Uuid
  resource    String
  action      String
  description String

  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model UserRole {
  userId String @map("user_id") @db.Uuid
  roleId String @map("role_id") @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model RefreshToken {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  tokenHash  String   @unique @map("token_hash")
  deviceInfo String?  @map("device_info")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// =============================================================================
// LOCATIONS
// =============================================================================

model Location {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  parentId  String?  @map("parent_id") @db.Uuid
  name      String
  code      String
  type      String   // site, building, floor, area, room
  address   String?
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  metadata  Json?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  parent               Location?             @relation("LocationHierarchy", fields: [parentId], references: [id])
  children             Location[]            @relation("LocationHierarchy")
  assets               Asset[]
  workOrders           WorkOrder[]
  maintenanceSchedules MaintenanceSchedule[]
  inventoryItems       InventoryItem[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([parentId])
  @@map("locations")
}

// =============================================================================
// ASSETS
// =============================================================================

model Asset {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  locationId      String?  @map("location_id") @db.Uuid
  parentAssetId   String?  @map("parent_asset_id") @db.Uuid
  name            String
  assetTag        String   @map("asset_tag")
  serialNumber    String?  @map("serial_number")
  manufacturer    String?
  model           String?
  category        String?
  status          String   @default("operational") // operational, maintenance, offline, retired
  purchaseDate    DateTime? @map("purchase_date") @db.Date
  warrantyExpires DateTime? @map("warranty_expires") @db.Date
  specifications  Json?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  location             Location?             @relation(fields: [locationId], references: [id])
  parentAsset          Asset?                @relation("AssetHierarchy", fields: [parentAssetId], references: [id])
  childAssets          Asset[]               @relation("AssetHierarchy")
  workOrders           WorkOrder[]
  maintenanceSchedules MaintenanceSchedule[]

  @@unique([tenantId, assetTag])
  @@index([tenantId])
  @@index([locationId])
  @@index([status])
  @@map("assets")
}

// =============================================================================
// WORK ORDERS
// =============================================================================

model WorkOrder {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  workOrderNumber String    @map("work_order_number")
  assetId         String?   @map("asset_id") @db.Uuid
  locationId      String?   @map("location_id") @db.Uuid
  createdById     String    @map("created_by_id") @db.Uuid
  assignedToId    String?   @map("assigned_to_id") @db.Uuid
  title           String
  description     String?
  type            String    @default("reactive") // reactive, preventive, predictive, inspection
  priority        String    @default("medium") // low, medium, high, critical
  status          String    @default("open") // open, in_progress, on_hold, completed, cancelled
  dueDate         DateTime? @map("due_date")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  estimatedHours  Int?      @map("estimated_hours")
  actualHours     Int?      @map("actual_hours")
  completionNotes String?   @map("completion_notes")
  version         Int       @default(1)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  tenant            Tenant               @relation(fields: [tenantId], references: [id])
  asset             Asset?               @relation(fields: [assetId], references: [id])
  location          Location?            @relation(fields: [locationId], references: [id])
  createdBy         User                 @relation("CreatedBy", fields: [createdById], references: [id])
  assignedTo        User?                @relation("AssignedTo", fields: [assignedToId], references: [id])
  steps             WorkOrderStep[]
  comments          WorkOrderComment[]
  signatures        WorkOrderSignature[]
  photos            WorkOrderPhoto[]
  scheduledWorkOrders ScheduledWorkOrder[]
  laborEntries      WorkOrderLabor[]
  partsUsed         WorkOrderPart[]

  @@unique([tenantId, workOrderNumber])
  @@index([tenantId])
  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([assetId])
  @@index([locationId])
  @@index([dueDate])
  @@index([createdAt])
  @@map("work_orders")
}

model WorkOrderStep {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  workOrderId     String    @map("work_order_id") @db.Uuid
  stepOrder       Int       @map("step_order")
  title           String
  description     String?
  isRequired      Boolean   @default(true) @map("is_required")
  isCompleted     Boolean   @default(false) @map("is_completed")
  completedById   String?   @map("completed_by_id") @db.Uuid
  completedAt     DateTime? @map("completed_at")
  completionNotes String?   @map("completion_notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  completedBy User?     @relation("CompletedBy", fields: [completedById], references: [id])

  @@index([workOrderId])
  @@index([tenantId])
  @@map("work_order_steps")
}

model WorkOrderComment {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  workOrderId String @map("work_order_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  parentId  String?  @map("parent_id") @db.Uuid
  content   String
  isInternal Boolean @default(false) @map("is_internal")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workOrder WorkOrder          @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id])
  parent    WorkOrderComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   WorkOrderComment[] @relation("CommentReplies")

  @@index([workOrderId])
  @@index([tenantId])
  @@map("work_order_comments")
}

model WorkOrderSignature {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  workOrderId   String   @map("work_order_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  signatureData String   @map("signature_data")
  type          String   // technician, supervisor, customer
  signedAt      DateTime @default(now()) @map("signed_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@index([workOrderId])
  @@index([tenantId])
  @@map("work_order_signatures")
}

model WorkOrderPhoto {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  workOrderId String   @map("work_order_id") @db.Uuid
  uploadedById String  @map("uploaded_by_id") @db.Uuid
  filename    String
  mimeType    String   @map("mime_type")
  size        Int      // bytes
  url         String   // Storage URL or base64 data URI
  caption     String?
  category    String?  // before, during, after, damage, repair
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workOrder  WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  uploadedBy User      @relation("PhotoUploadedBy", fields: [uploadedById], references: [id])

  @@index([workOrderId])
  @@index([tenantId])
  @@map("work_order_photos")
}

model WorkOrderLabor {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  workOrderId String    @map("work_order_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  startTime   DateTime  @map("start_time")
  endTime     DateTime? @map("end_time")
  hours       Decimal?  @db.Decimal(5, 2) // Calculated from start/end or entered manually
  description String?
  laborType   String    @default("regular") @map("labor_type") // regular, overtime, travel
  hourlyRate  Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user      User      @relation("LaborUser", fields: [userId], references: [id])

  @@index([workOrderId])
  @@index([userId])
  @@index([tenantId])
  @@map("work_order_labor")
}

model WorkOrderPart {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  workOrderId     String   @map("work_order_id") @db.Uuid
  inventoryItemId String?  @map("inventory_item_id") @db.Uuid
  addedById       String   @map("added_by_id") @db.Uuid

  // Part details (can be from inventory or manual entry)
  partNumber      String?  @map("part_number")
  partName        String   @map("part_name")
  quantity        Int
  unitCost        Decimal? @map("unit_cost") @db.Decimal(10, 2)
  totalCost       Decimal? @map("total_cost") @db.Decimal(10, 2)
  notes           String?

  // Status tracking
  status          String   @default("used") // used, returned, damaged

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  workOrder     WorkOrder      @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id])
  addedBy       User           @relation("PartAddedBy", fields: [addedById], references: [id])

  @@index([workOrderId])
  @@index([inventoryItemId])
  @@index([tenantId])
  @@map("work_order_parts")
}

// =============================================================================
// NOTIFICATIONS
// =============================================================================

model Notification {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      String    // work_order_assigned, work_order_completed, etc.
  title     String
  body      String
  data      Json?     // Entity references
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([tenantId])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id               String  @id @default(uuid()) @db.Uuid
  userId           String  @map("user_id") @db.Uuid
  notificationType String  @map("notification_type")
  emailEnabled     Boolean @default(true) @map("email_enabled")
  pushEnabled      Boolean @default(true) @map("push_enabled")
  inAppEnabled     Boolean @default(true) @map("in_app_enabled")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@map("notification_preferences")
}

// =============================================================================
// SCHEDULING (Preventive Maintenance)
// =============================================================================

model MaintenanceSchedule {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  name            String
  description     String?
  assetId         String?  @map("asset_id") @db.Uuid
  locationId      String?  @map("location_id") @db.Uuid
  priority        String   @default("medium") // low, medium, high, critical
  estimatedHours  Int?     @map("estimated_hours")
  assignedToId    String?  @map("assigned_to_id") @db.Uuid

  // Recurrence pattern (RFC 5545 inspired)
  frequency       String   // daily, weekly, biweekly, monthly, quarterly, yearly, custom
  interval        Int      @default(1) // Every N days/weeks/months
  daysOfWeek      Int[]    @default([]) @map("days_of_week") // 0=Sun, 1=Mon, etc.
  dayOfMonth      Int?     @map("day_of_month") // 1-31
  monthOfYear     Int?     @map("month_of_year") // 1-12

  // Schedule window
  startDate       DateTime @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  leadTimeDays    Int      @default(7) @map("lead_time_days") // Days before due date to create WO

  // Work order template
  workOrderTitle  String   @map("work_order_title")
  workOrderType   String   @default("preventive") @map("work_order_type")

  // Status
  isActive        Boolean  @default(true) @map("is_active")
  lastGeneratedAt DateTime? @map("last_generated_at")
  nextDueDate     DateTime? @map("next_due_date") @db.Date

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant     Tenant                   @relation(fields: [tenantId], references: [id])
  asset      Asset?                   @relation(fields: [assetId], references: [id])
  location   Location?                @relation(fields: [locationId], references: [id])
  assignedTo User?                    @relation("ScheduleAssignedTo", fields: [assignedToId], references: [id])
  steps      MaintenanceScheduleStep[]
  generatedWorkOrders ScheduledWorkOrder[]

  @@index([tenantId])
  @@index([assetId])
  @@index([locationId])
  @@index([isActive, nextDueDate])
  @@map("maintenance_schedules")
}

model MaintenanceScheduleStep {
  id          String   @id @default(uuid()) @db.Uuid
  scheduleId  String   @map("schedule_id") @db.Uuid
  stepOrder   Int      @map("step_order")
  title       String
  description String?
  isRequired  Boolean  @default(true) @map("is_required")

  // Relations
  schedule MaintenanceSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@map("maintenance_schedule_steps")
}

model ScheduledWorkOrder {
  id          String   @id @default(uuid()) @db.Uuid
  scheduleId  String   @map("schedule_id") @db.Uuid
  workOrderId String   @map("work_order_id") @db.Uuid
  scheduledFor DateTime @map("scheduled_for") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  schedule  MaintenanceSchedule @relation(fields: [scheduleId], references: [id])
  workOrder WorkOrder           @relation(fields: [workOrderId], references: [id])

  @@index([scheduleId])
  @@index([workOrderId])
  @@map("scheduled_work_orders")
}

// =============================================================================
// INVENTORY
// =============================================================================

model InventoryItem {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  itemNumber      String   @map("item_number")
  name            String
  description     String?
  category        String?
  unit            String   @default("each") // each, box, pack, liter, kg, etc.
  currentStock    Int      @default(0) @map("current_stock")
  minimumStock    Int      @default(0) @map("minimum_stock")
  reorderPoint    Int      @default(0) @map("reorder_point")
  reorderQuantity Int      @default(0) @map("reorder_quantity")
  unitCost        Decimal? @map("unit_cost") @db.Decimal(10, 2)
  manufacturer    String?
  partNumber      String?  @map("part_number")
  barcode         String?
  locationId      String?  @map("location_id") @db.Uuid
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant         Tenant                 @relation(fields: [tenantId], references: [id])
  location       Location?              @relation(fields: [locationId], references: [id])
  transactions   InventoryTransaction[]
  workOrderParts WorkOrderPart[]

  @@unique([tenantId, itemNumber])
  @@index([tenantId])
  @@index([category])
  @@index([barcode])
  @@index([currentStock])
  @@map("inventory_items")
}

model InventoryTransaction {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  itemId          String   @map("item_id") @db.Uuid
  type            String   // receipt, issue, adjustment, transfer, return
  quantity        Int
  previousStock   Int      @map("previous_stock")
  newStock        Int      @map("new_stock")
  unitCost        Decimal? @map("unit_cost") @db.Decimal(10, 2)
  reference       String?  // Work order number, PO number, etc.
  referenceId     String?  @map("reference_id") @db.Uuid
  notes           String?
  performedById   String   @map("performed_by_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  item        InventoryItem @relation(fields: [itemId], references: [id])
  performedBy User          @relation(fields: [performedById], references: [id])

  @@index([tenantId])
  @@index([itemId])
  @@index([type])
  @@index([createdAt])
  @@map("inventory_transactions")
}

// =============================================================================
// AUDIT LOG
// =============================================================================

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id") @db.Uuid
  action     String   // create, update, delete
  changes    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, createdAt])
  @@index([userId])
  @@map("audit_logs")
}
